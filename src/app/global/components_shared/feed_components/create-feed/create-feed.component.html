<div class="p-4 user-form position-relative">
    <h3 class="mb-4">Create a Feed</h3>

    <form
        class="text-left"
        [formGroup]="new_feed_form"
        (ngSubmit)="saveFeed()"
        class="text-left"
        #formDirective="ngForm">
        <div class="d-flex flex-column">
            <mat-form-field class="full-width">
                <mat-label>Feed Type</mat-label>
                <mat-select formControlName="feedType">
                    <mat-option *ngFor="let feed of feed_types" [value]="feed.id">
                        {{ feed.name }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field class="full-width">
                <mat-label>Feed Title</mat-label>
                <input matInput formControlName="feedTitle" matInput type="text" placeholder="Ex: ESPN News" />
            </mat-form-field>

            <mat-form-field class="full-width">
                <mat-label>Feed Description</mat-label>
                <input
                    matInput
                    formControlName="feedDescription"
                    matInput
                    type="text"
                    placeholder="Ex: ESPN Latest News Today" />
            </mat-form-field>

            <app-dealer-autocomplete
                *ngIf="hasLoadedDealers; else loadingDealers"
                (dealer_selected)="dealerSelected($event)"
                [initial_value]="selectedDealer"
                [active_only]="true"
                [isDisabled]="isCurrentUserDealer">
            </app-dealer-autocomplete>

            <ng-container *ngIf="!has_selected_widget_feed_type; else textAreaScript">
                <div class="position-relative">
                    <mat-form-field class="full-width">
                        <mat-label>Feed URL</mat-label>
                        <input
                            matInput
                            formControlName="feedUrl"
                            matInput
                            type="text"
                            placeholder="URL needs to be working" />
                    </mat-form-field>
                </div>
            </ng-container>

            <ng-template #textAreaScript>
                <mat-form-field class="full-width">
                    <textarea
                        matInput
                        placeholder="Paste your widget here"
                        formControlName="embeddedscript"
                        cdkTextareaAutosize
                        cdkAutosizeMinRows="10"
                        cdkAutosizeMaxRows="15">
                    </textarea>
                </mat-form-field>
            </ng-template>
        </div>

        <!-- LOADER/SPINNER FOR FEED URL CHANGES -->
        <ng-container *ngIf="isCheckingUrl; else showUrlCheckResults">
            <div class="spinner-container d-flex justify-content-between mb-2">
                <app-spinner [diameter]="35" [message]="checkFeedUrlText"></app-spinner>
            </div>
        </ng-container>

        <ng-template #showUrlCheckResults>
            <ng-container *ngIf="!isInitialUrlCheck">
                <div class="alert" [ngClass]="getAlertClass()">
                    <p class="sm-text font-weight-bold">
                        <ng-container *ngIf="!feedUrlHasValue">URL is required!</ng-container>
                        <ng-container *ngIf="feedUrlHasValue && !hasValidUrlFormat">
                            Invalid format. Please check the URL provided.
                        </ng-container>
                        <ng-container *ngIf="validUrlNoAccess">
                            The URL may not be accessible. Please ensure that it can be accessed via the browser.
                        </ng-container>
                        <ng-container *ngIf="validUrl"> URL is valid </ng-container>
                    </p>
                </div>
            </ng-container>
        </ng-template>

        <div class="d-flex flex-even align-items-center">
            <ng-container *ngIf="!has_selected_widget_feed_type; else widgetButton">
                <button
                    mat-button
                    mat-raised-button
                    class="theme-btn mr-2"
                    [disabled]="isFormInvalid()"
                    *ngIf="!isCreatingFeed">
                    <ng-container> Submit </ng-container>
                </button>

                <button mat-button mat-raised-button class="theme-btn mr-2 unclickable" *ngIf="isCreatingFeed">
                    <ng-container *ngIf="isCreatingFeed">Creating feed...</ng-container>
                </button>
            </ng-container>

            <ng-template #widgetButton>
                <button
                    mat-button
                    mat-raised-button
                    class="theme-btn mr-2"
                    [disabled]="new_feed_form.invalid || !dealerHasValue">
                    <ng-container *ngIf="isCreatingFeed"> Creating feed... </ng-container>
                    <ng-container *ngIf="!isCreatingFeed"> Submit </ng-container>
                </button>
            </ng-template>

            <button mat-button mat-raised-button class="theme-btn btn-danger" mat-dialog-close>Cancel</button>
        </div>
    </form>

    <ng-template #loading>
        <div class="py-5">
            <app-spinner></app-spinner>
        </div>
    </ng-template>
</div>

<ng-template #loadingDealers>
    <div class="spinner-container d-flex align-items-center justify-content-between">
        <h4>Loading dealers...</h4>
        <app-spinner [diameter]="35"></app-spinner>
    </div>
</ng-template>
