<div class="container p-2" id="addTagModal">
    <div class="d-flex align-items-start">
        <div class="flex-even">
            <h3>{{ title }}</h3>
            <p class="sm-text mb-4">{{ description }}</p>
        </div>
        <div class="modal-control">
            <button class="modal-close-btn no-border no-background" (click)="closeModal()">
                <span class="fas fa-times"></span>
            </button>
        </div>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="existing-add-field">
            <h4>Use existing tags:</h4>
            <mat-form-field class="full-width">
                <mat-select #tagMultiSelect formControlName="existing" [placeholder]="'Choose a tag'" [multiple]="true">
                    <mat-option>
                        <ngx-mat-select-search
                            noEntriesFoundLabel="No results"
                            formControlName="tagFilter"
                            [placeholderLabel]="'Search a tag'"
                            [clearSearchInput]="false"
                            [searching]="isSearchingTags">
                            <mat-icon class="clear" ngxMatSelectSearchClear>close</mat-icon>
                        </ngx-mat-select-search>
                    </mat-option>

                    <mat-option *ngFor="let tag of filteredTags | async" [value]="tag">
                        <div class="tag">{{ tag.name }}</div>
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="divider my-4">
            <div class="or-text">
                <small class="font-weight-bold">OR</small>
            </div>
        </div>

        <div class="create-new-tag-field">
            <h4>Create new tag:</h4>
            <div class="row">
                <div class="col-lg-6">
                    <mat-form-field class="full-width">
                        <mat-label>Tag Color</mat-label>
                        <input
                            matInput
                            type="text"
                            formControlName="tagColor"
                            autocomplete="off"
                            [(colorPicker)]="selectedTagColor"
                            [cpAlphaChannel]="'disabled'"
                            [cpDisableInput]="true"
                            [style.background]="selectedTagColor"
                            [value]="selectedTagColor || ''"
                            (colorPickerChange)="onSelectTagColor(selectedTagColor)" />
                    </mat-form-field>
                </div>

                <div class="col-lg-6">
                    <mat-form-field class="tag-name full-width">
                        <input matInput type="text" formControlName="name" placeholder="Tag Name" />
                    </mat-form-field>
                </div>

                <div class="col-lg-12">
                    <mat-form-field class="tag-description full-width">
                        <input matInput type="text" formControlName="description" placeholder="Tag Description" />
                    </mat-form-field>
                </div>
            </div>

            <div class="d-flex align-items-center">
                <mat-slide-toggle
                    class="exclude-toggle"
                    formControlName="exclude"
                    [checked]="form.get('exclude').value"
                    [labelPosition]="'before'"
                    *ngIf="_isAdmin()">
                    <small class="font-weight-bold mr-2">Exclude tag?</small>
                </mat-slide-toggle>

                <div class="flex-even text-right">
                    <button
                        class="add theme-btn _primary"
                        mat-button
                        mat-raised-button
                        (click)="onAddTag()"
                        [disabled]="cannotAddTag()">
                        <ng-container *ngIf="isCheckingTagExistence; else doneChecking">
                            <i class="fas fa-eye-slash"></i>
                        </ng-container>
                        <ng-template #doneChecking> Add </ng-template>
                    </button>
                </div>
            </div>
        </div>

        <hr />

        <div class="row mb-3">
            <div class="col-lg-12">
                <h5 class="mb-2">To Create:</h5>

                <div class="selected-tags-area">
                    <ng-container *ngIf="form.get('new').value.length; else no_data">
                        <div
                            *ngFor="let tag of form.get('new').value; let i = index"
                            [style.backgroundColor]="tag.tagColor"
                            class="tag-pill">
                            <small matTooltip="{{ tag.description }}" class="font-weight-bold sm-text mr-2">
                                {{ tag.name }}
                            </small>

                            <ng-container *ngIf="tag.exclude">
                                <i class="fas fa-eye-slash xsm-text mr-2"></i>
                            </ng-container>

                            <button type="button" class="tag-pill__delete" (click)="onRemoveTag(i, 'new', tag)">
                                <i class="fas fa-times cursor-pointer sm-text"></i>
                            </button>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-lg-12">
                <h5 class="mb-2">To Assign:</h5>

                <div class="selected-tags-area">
                    <ng-container *ngIf="form.get('existing').value.length; else no_data">
                        <div
                            *ngFor="let tag of form.get('existing').value; let i = index"
                            [style.backgroundColor]="tag.tagColor"
                            class="tag-pill">
                            <small matTooltip="{{ tag.description }}" class="font-weight-bold sm-text mr-2">
                                {{ tag.name }}
                            </small>

                            <ng-container *ngIf="tag.exclude">
                                <i class="fas fa-eye-slash xsm-text mr-2"></i>
                            </ng-container>

                            <button type="button" class="tag-pill__delete" (click)="onRemoveTag(i, 'existing', tag)">
                                <i class="fas fa-times cursor-pointer sm-text"></i>
                            </button>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-12">
                <h5 class="mb-2">Current:</h5>

                <div class="selected-tags-area">
                    <ng-container *ngIf="currentTags.length; else no_data">
                        <div
                            *ngFor="let tag of currentTags; let i = index"
                            [style.backgroundColor]="tag.tagColor"
                            class="tag-pill">
                            <small matTooltip="{{ tag.description }}" class="font-weight-bold sm-text mr-2">
                                {{ tag.name }}
                            </small>

                            <ng-container *ngIf="tag.exclude">
                                <i class="fas fa-eye-slash xsm-text mr-2"></i>
                            </ng-container>

                            <button type="button" class="tag-pill__delete" (click)="onRemoveTag(i, 'current', tag)">
                                <i class="fas fa-times cursor-pointer sm-text"></i>
                            </button>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>

        <button
            mat-button
            mat-raised-button
            class="submit theme-btn _primary"
            type="submit"
            [disabled]="cannotSubmitTags() || submitting">
            <span *ngIf="!submitting; else submitting_btn">Submit</span>

            <ng-template #submitting_btn>
                <span class="mr-2">Please wait</span>
                <i class="fas fa-spinner fa-spin"></i>
            </ng-template>
        </button>

        <ng-template #no_data>
            <small class="font-weight-bold">No Data</small>
        </ng-template>
    </form>
</div>
